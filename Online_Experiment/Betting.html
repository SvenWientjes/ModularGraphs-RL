<!DOCTYPE html>
<html>
    <head>
        <title>Art Dealer</title>
        <script src="jspsych-6.2.0/jspsych.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-instructions.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-canvas-keyboard-response.js"></script>
        <script src="js/StimulusCanvas.js"></script>
        <script src="js/EntryScreen.js"></script>
        <script src="js/WelcomeScreen.js"></script>
        <script src="js/FeedbackScreen.js"></script>
        <script src="js/Instructions.js"></script>
        <script src="js/MiniblockEnd.js"></script>
        <script src="js/telelist.js"></script>
        <script src="js/TeleportQuestion.js"></script>
        <script src="js/stimLists.js"></script>
        <script src="js/Practice.js"></script>
        <script src="js/trajectories.js"></script> <!-- Experiment defining variables -->
        <script src="js/goallist.js"></script> <!-- Experiment defining variables -->
        <script src="js/FixationCanvas.js"></script> 
        <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
        <link href="css/custom_styles.css" rel="stylesheet" type="text/css">
    </head>
    <body></body>
    <script>

    /* -------- EXPERIMENT DEFINING VARIABLES -------- */
    // Manipulable Variables
    var ppn = 1;         // Participant Nr
    var nTrs = 2;        // How many trials to display? (max 100)
    var total_reward = 0;       // Beginning reward
    var practice_reward = 0;    // Beginning reward for practice trials

    // Fixed initialization variables
    var timeline = [];   // Timeline
    var newcoin = true;  // Coin-responded checker
    var trialorder = trajectories[ppn]; // Index for trials
    var goalorder = goallist[ppn];      // Index for goals
    var next_total_reward = 0;  // Carry reward through mb-feedback
    var nWin = 0;               // Count how often the target painting was seen
    var miss = false;           // Index if response was omitted (fixation feedback)
    var mbendf = 'downend';     // Miniblock-feedback
    var condLMidx=0;            // Was the last trial response omitted?
    var waspressed = 0;         // Previous choice in choosing entry rooms
    var trBet = 0;    // Variable tracks current bet within miniblock
    var trRew = 0;    // Variable tracks reward differential per trial within miniblock
    var mbPunish = 0; // Variable tracks reward punishment for omitted responses
    var entryQlist = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14]]; // Definition of entry room presentations
    entryQlist = jsPsych.randomization.shuffle(entryQlist);      // Shuffle of trial order
    entryQlist = entryQlist.map(jsPsych.randomization.shuffle);  // Shuffle of room ordering within trial
    
    // Get rooms and goals into shuffled order
    var idxArray = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];
    var shfIdx = jsPsych.randomization.shuffle(idxArray);
    var rooms = [];
    shfIdx.forEach(i => rooms.push(roomsdef[i]));
    var goals = [];
    shfIdx.forEach(i => goals.push(goalsdef[i]));
    console.log(rooms);
    
    // Generate array of preloading images
    var pre_load_stimuli = ['img/Hallway.png', rooms, goals, 'img/3coin-illustrate.png',
                            'img/4coin-illustrate.png', 'img/example-goal.jpg', 'img/fixHallway.png', 'img/omitHallway.png', pracRooms];

    /* -------- Define timeline order of instructions etc -------- */
    // Add welcome screens to timeline
    timeline.push(welcome);
    timeline.push(qIntro);
    timeline.push(survey_trial);
    timeline.push(fsIntro);

    // Go fullscreen from here on out
    timeline.push({
        type: 'fullscreen',
        fullscreen_mode: true
    });
    // Push written instructions
    timeline.push(instr1);

    /* -------- Define practice trial order -------- */
    var winPracBlock = {
        timeline: [fixation, trial],
        timeline_variables: winPractice
    }
    var losePracBlock = {
        timeline: [fixation, trial],
        timeline_variables: losePractice
    }
    // Conditional display you failed
    var repeat_prac1 = {
        timeline: [pracFail1],
        conditional_function: function(){
            return trBet!=5;
        }
    }
    var repeat_prac2 = {
        timeline: [pracFail2],
        conditional_function: function(){
            var upcount = jsPsych.data.get().filter([{miniblock:-1}]).last(5).filter({decision:'up'}, {decision:'upgoal'}).count();
            var downcount = jsPsych.data.get().filter([{miniblock:-1}]).last(5).filter({decision:'down'}, {decision:'downgoal'}).count();
            var misscount = jsPsych.data.get().filter([{miniblock:-1}]).last(5).filter({decision:'miss'}, {decision:'missgoal'}).count();
            if(upcount>0 && downcount>0 && misscount>0){
                return false
            }else{
                return true
            }
        }
    }
    // Loop practice until all required responses
    var loop_prac1 = {
        timeline: [pracInstr1, pracGoal, winPracBlock, conditionallastmiss, repeat_prac1],
        loop_function: function(data){
            return trBet!=5;
        }
    }
    var loop_prac2 = {
        timeline: [pracInstr2, pracGoal, losePracBlock, conditionallastmiss, repeat_prac2],
        loop_function: function(data){
            var upcount = jsPsych.data.get().filter([{miniblock:-1}]).last(5).filter({decision:'up'}, {decision:'upgoal'}).count();
            var downcount = jsPsych.data.get().filter([{miniblock:-1}]).last(5).filter({decision:'down'}, {decision:'downgoal'}).count();
            var misscount = jsPsych.data.get().filter([{miniblock:-1}]).last(5).filter({decision:'miss'}, {decision:'missgoal'}).count();
            if(upcount>0 && downcount>0 && misscount>0){
                return false
            }else{
                return true
            }
        }
    }
    
    timeline.push(loop_prac1);
    timeline.push(blockend);
    timeline.push(pointfb);
    timeline.push(pracFb1);
    timeline.push(loop_prac2);
    timeline.push(blockend);
    timeline.push(pointfb);
    timeline.push(finprac);

    /* -------- Define screens and timeline order of main experiment -------- */
    // Define a miniblock!
    for (var i=0; i<nTrs; i++) {
        // Get images in array in order of presentation on trial 
        var node_imgs = [];
        for (var j=0; j<15; j++) { //iterate over trialorder to add stimuli
            node_imgs.push({
                stimulus: rooms[trialorder[i][j]],
                trialidx: j,
                mbidx: i,
                goalidx: goalorder[i],
                nodeid: trialorder[i][j]
            });
        }
        // Get timeline variable for goal
        var varGoal = {
            timeline: [goalcue],
            timeline_variables: [
                {thegoal: goals[goalorder[i]]}
            ]
        }
        // Get timeline variables for display rooms
        var miniblock = {
            timeline: [fixation, trial],
            timeline_variables: node_imgs,
        }
        // Push into timeline 
        timeline.push(varGoal);
        timeline.push(miniblock);
        timeline.push(conditionallastmiss);
        timeline.push(blockend);
        timeline.push(pointfb);
    } 

    // Congratulate on finishing the main experiment
    // Ask if they saw any room more than others?

    // Create timeline variable for indexing tele questions
    var teleIdx = [];
    for (var j=0; j<3; j++) { //iterate over trialorder to add stimuli
        teleIdx.push({
            tidx: j
        });
    }

    // Prompt for tele questions

    // Screen for tele questions
    var teleChoice = {
        type: 'html-button-response',
        stimulus: teleStr,
        choices: ['1','2','3','4','5'],
        button_html: btnStr,
        on_load: function(){
            TeleC(jsPsych.timelineVariable('tidx',true));
        },
        on_finish: function(data){
            data.teledecision = telelist[ppn][jsPsych.timelineVariable('tidx',true)][data.button_pressed];
            data.options = telelist[ppn][jsPsych.timelineVariable('tidx',true)];
        }
    }
    var teleWait = {
        type: 'html-keyboard-response',
        stimulus: '<canvas id="WaitCv" width="1920" height="1080" style="background-color:black"</canvas>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000
    }
    // Push into timeline
    var teleblock ={
        timeline: [teleChoice,teleWait],
        timeline_variables:teleIdx,
    }
    timeline.push(teleblock);

    // Create questions about wing entries
    // Create timeline variable for indexing entry questions
    var entryIdx = [];
    for (var j=0; j<3; j++) { //iterate over trialorder to add stimuli
        entryIdx.push({
            eidx: j
        });
    }

    // Set up the choice screen
    var entryChoice1 = {
        type: 'html-button-response',
        stimulus: '<canvas id="ChoiceCv" width="1920" height="1080" style="background-color:black"</canvas>',
        choices: ['1','2','3','4','5'],
        button_html: function(){
            return(EntryBtnGen(entryQlist[jsPsych.timelineVariable('eidx',true)], -1));
        },
        on_load: function(){
            EntryC('bub',-1);
        },
        on_finish: function(data){
            data.decision = entryQlist[jsPsych.timelineVariable('eidx',true)][data.button_pressed]
            data.options = entryQlist[jsPsych.timelineVariable('eidx',true)];
        }
    }

    // Set up the choice screen
    var entryChoice2 = {
        type: 'html-button-response',
        stimulus: '<canvas id="ChoiceCv" width="1920" height="1080" style="background-color:black"</canvas>',
        choices: ['1','2','3','4'],
        button_html: function(){
            waspressed = jsPsych.data.get().last(1).values()[0].button_pressed;
            return(EntryBtnGen(entryQlist[jsPsych.timelineVariable('eidx',true)], waspressed));
        },
        on_load: function(){
            waspressed = jsPsych.data.get().last(1).values()[0].button_pressed;
            orderedrooms = entryQlist[jsPsych.timelineVariable('eidx',true)];
            EntryC(rooms[orderedrooms[waspressed]], waspressed);
        },
        on_finish: function(data){
            if(data.button_pressed >= waspressed){
                data.button_pressed += 1;
            }
            data.decision = entryQlist[jsPsych.timelineVariable('eidx',true)][data.button_pressed]
            data.options = entryQlist[jsPsych.timelineVariable('eidx',true)];
        }
    }

    //Push into timeline
    var entryblock ={
        timeline: [entryChoice1, entryChoice2],
        timeline_variables:entryIdx,
    }
    timeline.push(entryblock);

    // Start the experiment
    jsPsych.init({
        timeline: timeline,
        preload_images: pre_load_stimuli,
        on_finish: function() {
            //jsPsych.data.displayData('csv');
            jsPsych.data.get().localSave('csv','mydata.csv');
        }
    });

    </script>
</html>