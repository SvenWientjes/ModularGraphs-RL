<!DOCTYPE html>
<html>
    <head>
        <title>My experiment</title>
        <script src="jspsych-6.2.0/jspsych.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-canvas-keyboard-response.js"></script>
        <script src="js/FeedbackScreens.js"></script> <!-- Experiment defining variables -->
        <script src="js/StimulusCanvas.js"></script>
        <script src="js/telelist.js"></script>
        <script src="js/TeleportQuestion.js"></script>
        <script src="js/stimLists.js"></script>
        <script src="js/trajectories.js"></script> <!-- Experiment defining variables -->
        <script src="js/goallist.js"></script> <!-- Experiment defining variables -->
        <script src="js/FixationCanvas.js"></script> 
        <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
        <link href="css/custom_button.css" rel="stylesheet" type="text/css">
    </head>
    <body></body>
    <script>

    /* Create timeline */
    var timeline = [];

    // Create variable for coin-tracking
    var newcoin = true;
    
    /* Define welcome screen */
    var welcome = {
        type: "html-keyboard-response",
        stimulus: "Welcome to the experiment. Press any key to begin."
    };

    /* Add welcome screen to timeline */
    timeline.push(welcome);

    var instructions = {
        type: "html-keyboard-response",
        stimulus: "<p>This screen will contain the instructions for the task.</p>"+
        "<p>We might use multiple instruction screens to properly display the "+
        "different types of screens (goal, start, feedback, etc) the participant can encounter.</p>"+
        "<p>We should also instruct them they have to press the spacebar.</p>",
        post_trial_gap: 2000
    };

    var survey_trial = {
        type: 'survey-text',
        questions: [
            {prompt: "How old are you?", name: 'Age'}, 
            {prompt: "Where were you born?", name: 'BirthLocation'},
            {prompt: "What is your participant number?", name: 'Ppn'}
        ],
        on_finish: function(data) {
            pResponses = JSON.parse(data.responses);
            var PN = parseInt(pResponses.Ppn);
        }
    };

    // Add instruction screen to timeline 
    timeline.push(instructions);
    timeline.push(survey_trial);
    
    // Define which trajectories to follow (pregenerated participant / experiments)
    var ppn = 1;
    var trialorder = trajectories[ppn];
    var goalorder = goallist[ppn];

    // Get rooms and goals into shuffled order
    var idxArray = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];
    var shfIdx = jsPsych.randomization.shuffle(idxArray);

    var rooms = [];
    shfIdx.forEach(i => rooms.push(roomsdef[i]));
    var goals = [];
    shfIdx.forEach(i => goals.push(goalsdef[i]));
    console.log(rooms);

    // Generate array of preloading images
    var pre_load_stimuli = ['img/Hallway.png', rooms, goals];

    // Define earned points throughout experiment (will be updated)
    var total_reward = 0;
    var miss = false;

    // Go fullscreen from here on out
    timeline.push({
        type: 'fullscreen',
        fullscreen_mode: true
    });

    // Set up the fixation cross
    var fixation = {
        type: 'html-keyboard-response',
        stimulus: FixStr,
        on_load: function(){
            FixationC(miss, trBet);
            miss=false;
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: function(){
            return [500,750,1000][Math.floor(Math.random()*3)]
        }
    }

    mbendf = 'downend';

    // Missed punishment feedback if last trial is missed
    var lastmiss = {
        type: 'html-keyboard-response',
        stimulus: FixStr,
        on_load: function(){
            FixationC(miss, trBet);
            miss=false;
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000
    }

    // Conditional lastmiss
    var conditionallastmiss = {
        timeline: [lastmiss],
        conditional_function: function(){
            return miss;
        }
    }

    // Message at the end of a miniblock
    var blockend = {
        type: 'html-keyboard-response',
        stimulus: function(){return miniblockFb(mbendf)}
        //choices: [32]
    }

    // Feedback w.r.t Points
    var pointfb = {
        type: 'html-keyboard-response',
        stimulus: function(){
            var nSteps = jsPsych.data.get().last(2).values()[0].nSteps;
            var trRew = jsPsych.data.get().last(2).values()[0].trRew;
            var nGoals = jsPsych.data.get().filter([{decision: 'upgoal'}, {decision: 'downgoal'}]).count();
            var trLeft = jsPsych.data.get().last(2).values()[0].miniblock;
            var mbPunish = jsPsych.data.get().last(2).values()[0].mbPunish;
            return fbScreen(nSteps, nGoals, trRew, trLeft, total_reward, mbPunish);
            
        }
        //choices: [32]
    }

    // Define a miniblock!
    for (var i=0; i<1; i++) {
        // Get images in array in order of presentation on trial 
        var node_imgs = [];
        for (var j=0; j<15; j++) { //iterate over trialorder to add stimuli
            node_imgs.push({
                stimulus: rooms[trialorder[i][j]],
                trialidx: j
            });
        }

        var trBet = 0;
        var trRew = 0;    // Variable tracks reward differential per trial within miniblock
        var mbPunish = 0; // Variable tracks reward punishment for omitted responses

        // Define the goalcue by getting from corresponding goalorder idx
        var goalcue = {
            type: 'image-keyboard-response',
            stimulus_width: 1920,
            choices: ['z','m'],
            stimulus: goals[goalorder[i]],
        }

        var trial = {
            type: 'html-keyboard-response',
            trial_duration: 1500,
            //stimulus_width: 1920,
            choices: ['z','m'], //down, up,
            response_ends_trial: false,
            stimulus: function(){var html='<div id="StimulusDiv" style="margin:0 auto;">';
                html+='<canvas id="StimulusCv" width="1920" height="1080" style="background:url('+jsPsych.timelineVariable('stimulus',true)+')"></canvas></div>';
                return html;}, //node_imgs in order determined by trialorder
            data: {
                miniblock: i,
                nSteps: jsPsych.timelineVariable('trialidx'),
                totRew: function(){
                    return total_reward;
                },
                trRew: function(){
                    return trRew;
                },
                trBet: function(){
                    return trBet;
                },
                mbPunish: function(){
                    return mbPunish;
                },
                node: function(){return rooms.indexOf(jsPsych.timelineVariable('stimulus', true))}, //node nr determined by idx of rooms
                goalnode: goalorder[i],
            },
            on_load: function(){StimC(trBet)},
            on_finish: function(data) {
                if (data.key_press == 90 && data.node == data.goalnode) { // Bet down on goal
                    trBet = Math.max(trBet,0);             // Do not increase bet by one
                    data.trBet = trBet;                    // Correct current trial bet
                    total_reward = Math.max(total_reward + trBet,0);   // Increment experiment reward by betted value
                    data.totRew = total_reward;            // Correct current trial reward
                    trRew = trBet;                         // Track miniblock-reward
                    data.trRew = trRew;                    // Append to trial data
                    mbendf = 'downgoal';
                    data.decision = mbendf;                // Append participant decision to trial data
                    trBet = 0;                             // Reset miniblock-bet for next miniblock
                    trRew = 0;                             // Reset miniblock-reward for next miniblock
                    mbPunish = 0;                          // Reset miniblock-punishment for next miniblock
                    miss = false;                          // Prevent carryover misses
                    jsPsych.endCurrentTimeline();
                };
                if (data.key_press == 77 && data.node == data.goalnode) { // Bet up on goal
                    trBet = Math.max(trBet+1,0);           // Increase bet by one
                    data.trBet = trBet;                    // Correct current trial bet
                    total_reward = Math.max(total_reward + trBet,0);   // Increment experiment reward by betted value
                    data.totRew = total_reward;            // Correct current trial reward
                    trRew = trBet;                         // Track miniblock-reward
                    data.trRew = trRew;                    // Append to trial data
                    mbendf = 'upgoal';
                    data.decision = mbendf;                // Append participant decision to trial data
                    trBet = 0;                             // Reset miniblock-bet for next miniblock
                    trRew = 0;                             // Reset miniblock-reward for next miniblock
                    mbPunish = 0;                          // Reset miniblock-punishment for next miniblock
                    miss = false;                          // Prevent carryover misses
                    jsPsych.endCurrentTimeline();
                };
                if (data.key_press == 90 && data.nSteps != 14 && data.node != data.goalnode) { // Down bet
                    trBet = Math.max(trBet,0);       // Do not increase bet by one
                    data.trBet = trBet;              // Correct current trial bet
                    data.decision = 'down';          // Append participant decision to trial data
                };
                if (data.key_press == 77 && data.nSteps != 14 && data.node != data.goalnode) { // Up bet
                    trBet = Math.max(trBet+1,0);     // Increase bet by one
                    data.trBet = trBet;              // Correct current trial bet
                    data.decision = 'up';            // Append participant decision to trial data 
                };
                if (data.key_press == 90 && data.nSteps == 14 && data.node != data.goalnode) { // Stop bet down
                    trBet = Math.max(trBet,0);             // Do not increase bet by one
                    data.trBet = trBet;                    // Correct current trial bet
                    total_reward = Math.max(total_reward - trBet,0);   // Increment experiment reward down by betted value (lost)
                    data.totRew = total_reward;            // Correct current trial reward
                    trRew = -trBet;                        // Track miniblock-reward
                    data.trRew = trRew;                    // Append to trial data
                    mbendf = 'downend';
                    data.decision = mbendf;                // Append participant decision to trial data
                    trBet = 0;                             // Reset miniblock-bet for next miniblock
                    trRew = 0;                             // Reset miniblock-reward for next miniblock
                    mbPunish = 0;                          // Reset miniblock-punishment for next miniblock
                    miss = false;                          // Prevent carryover misses
                };
                if (data.key_press == 77 && data.nSteps == 14 && data.node != data.goalnode) { // Stop bet UP
                    trBet = Math.max(trBet+1,0);           // Increase bet by one
                    data.trBet = trBet;                    // Correct current trial bet
                    total_reward = Math.max(total_reward - trBet,0);   // Increment experiment reward down by betted value (lost)
                    data.totRew = total_reward;            // Correct current trial reward
                    trRew = -trBet;                        // Track miniblock-reward
                    data.trRew = trRew;                    // Append to trial data
                    mbendf = 'upend';
                    data.decision = mbendf;                // Append participant decision to trial data
                    trBet = 0;                             // Reset miniblock-bet for next miniblock
                    trRew = 0;                             // Reset miniblock-reward for next miniblock
                    mbPunish = 0;                          // Reset miniblock-punishment for next miniblock
                    miss = false;                          // Prevent carryover misses
                };
                if (data.key_press == null && data.nSteps != 14 && data.node != data.goalnode) { //No response given
                    mbPunish = mbPunish - 1;                      // Tracks punishments over entire miniblock
                    data.mbPunish = mbPunish;                     // Correct current trial punishment
                    total_reward = Math.max(total_reward - 1,0);  // Punish total reward
                    data.totRew = total_reward;                   // Correct current total reward
                    data.trRew = trRew;                           // Correct current trial reward
                    miss = true;
                    data.decision = 'miss';
                };
                if (data.key_press == null && data.node == data.goalnode) {//No response to goal node
                    mbPunish = mbPunish - 1;               // Tracks punishment over entire miniblock
                    data.mbPunish = mbPunish;              // Correct current trial punishment
                    total_reward = Math.max(total_reward + trBet - 1,0);   // Increment experiment reward by betted value
                    data.totRew = total_reward;            // Correct current trial reward
                    trRew = trBet;                         // Track miniblock-reward
                    data.trRew = trRew;                    // Append to trial data
                    mbendf = 'missgoal';
                    data.decision = mbendf;                // Append participant decision to trial data
                    trBet = 0;                             // Reset miniblock-bet for next miniblock
                    trRew = 0;                             // Reset miniblock-reward for next miniblock
                    mbPunish = 0;                          // Reset miniblock-punishment for next miniblock
                    miss = true;                           // Prevent carryover misses in lastmiss
                    jsPsych.endCurrentTimeline();
                };
                if (data.key_press == null && data.nSteps == 14 && data.node != data.goalnode) { //No response - ending
                    mbPunish = mbPunish - 1;               // Tracks punishment over entire miniblock
                    data.mbPunish = mbPunish;              // Correct current trial punishment
                    total_reward = Math.max(total_reward - trBet - 1,0);   // Decrement experiment reward by betted value
                    data.totRew = total_reward;            // Correct current trial reward
                    trRew = -trBet;                        // Track miniblock-reward
                    data.trRew = trRew;                    // Append to trial data
                    mbendf = 'missend';
                    data.decision = mbendf;                // Append participant decision to trial data
                    trBet = 0;                             // Reset miniblock-bet for next miniblock
                    trRew = 0;                             // Reset miniblock-reward for next miniblock
                    mbPunish = 0;                          // Reset miniblock-punishment for next miniblock
                    miss = true;                           // Prevent carryover misses in lastmiss
                };
            }
        }

        var miniblock = {
            timeline: [fixation, trial],
            timeline_variables: node_imgs,
        }

        // Push into timeline 
        timeline.push(goalcue);
        timeline.push(miniblock);
        timeline.push(conditionallastmiss);
        timeline.push(blockend);
        timeline.push(pointfb);
    } 

    // Teleporter questionnaire
    var teleChoice = {
        type: 'html-button-response',
        stimulus: teleStr,
        choices: ['1','2','3','4','5'],
        button_html: btnStr,
        on_load: function(){
            TeleC(0);
        },
        on_finish: function(data){
            data.teledecision = telelist[ppn][0][data.button_pressed];
            data.options = telelist[ppn][0];
        }
    }

    timeline.push(teleChoice);

    // Start the experiment
    jsPsych.init({
        timeline: timeline,
        preload_images: pre_load_stimuli,
        on_finish: function() {
            //jsPsych.data.displayData('csv');
            jsPsych.data.get().localSave('csv','mydata.csv');
        }
    });

    </script>
</html>